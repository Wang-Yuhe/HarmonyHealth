// StepsPage.ets æ­¥æ•°æƒ…å†µé¡µé¢ (UI ä¼˜åŒ–ç‰ˆ)
import { BackButton } from '../../common/components/BackButton'
import { HealthDB } from '../../database/HealthDB';
import { HealthData } from '../../common/model/HealthData';
import { AuthUtil } from '../../common/utils/AuthUtil';
import { Context } from '@kit.AbilityKit'; // âœ… è¡¥ä¸Š Context å¼•ç”¨

@Component
struct StatCard {
  @Prop title: string = '';
  @Prop value: string = '';
  @Prop unit: string = '';
  @Prop color: string = '';

  build() {
    Column() {
      Row() {
        Circle({ width: 8, height: 8 })
          .fill(this.color)
          .margin({ right: 6 })
        Text(this.title)
          .fontSize(12)
          .fontColor('#666')
      }
      .width('100%')
      .margin({ bottom: 8 })

      Row() {
        Text(this.value)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
        Text(` ${this.unit}`)
          .fontSize(12)
          .fontColor('#999')
          .margin({ bottom: 4 })
      }
      .alignItems(VerticalAlign.Bottom)
    }
    .width('100%')
    .height(80)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .padding(16)
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Center)
    .shadow({ radius: 10, color: 'rgba(0,0,0,0.03)', offsetY: 4 })
  }
}

@Entry
@Component
struct StepsPage {
  @State stepsData: HealthData[] = [];
  @State todaySteps: number = 0;     // ðŸ‘ˆ ä»Šæ—¥æ­¥æ•°ï¼ˆåªæ¥è‡ªæ•°æ®åº“ï¼‰
  @State maxSteps: number = 1;
  @State minSteps: number = 0;
  @State avgSteps: number = 0;
  @State totalSteps: number = 0;
  @State avgCalories: number = 0;
  @State totalDistance: string = '0.0';

  private async refreshData() {
    const context = this.getUIContext().getHostContext() as Context;
    const user = await AuthUtil.getLoginUser(context);
    if (!user) return;

    // åªä¸ºâ€œè¿‡åŽ»å‡ å¤©â€è¡¥æ¨¡æ‹Ÿæ•°æ®ï¼Œä¸å†™ä»Šå¤©
    await HealthDB.getInstance().initMockHealthData(user.id, 7);

    // ä»Žæ•°æ®åº“æŒ‰å¤©æ±‡æ€»æœ€è¿‘ 7 å¤©
    this.stepsData = await HealthDB.getInstance().getDailyStepsSummary(user.id, 7);

    if (this.stepsData.length > 0) {
      // === æ ¸å¿ƒï¼šä»Ž DB æ±‡æ€»ç»“æžœé‡Œæ‹¿â€œä»Šå¤©â€çš„æ­¥æ•° ===
      const todayStr = new Date().toISOString().split('T')[0];
      const todayItem = this.stepsData.find(item => {
        const d = new Date(item.timestamp);
        return d.toISOString().split('T')[0] === todayStr;
      });
      this.todaySteps = todayItem ? todayItem.steps : 0;

      // ä¸‹é¢è¿™äº›ç»Ÿè®¡ä¾ç„¶åŸºäºŽ DB çš„ 7 å¤©æ±‡æ€»
      this.maxSteps = Math.max(...this.stepsData.map(d => d.steps));
      this.minSteps = Math.min(...this.stepsData.map(d => d.steps));

      this.totalSteps = this.stepsData.reduce((sum, item) => sum + item.steps, 0);
      this.avgSteps = Math.round(this.totalSteps / this.stepsData.length);

      const totalCalories = this.stepsData.reduce((sum, item) => sum + (item.calories || 0), 0);
      this.avgCalories = Math.round(totalCalories / this.stepsData.length);

      const dist = (this.totalSteps * 0.7 / 1000);
      this.totalDistance = isNaN(dist) ? '0.0' : dist.toFixed(1);

      if (this.maxSteps === this.minSteps) {
        this.minSteps = Math.max(0, this.maxSteps - 100);
      }
    } else {
      this.todaySteps = 0;
    }
  }

  async aboutToAppear() {
    await this.refreshData();
  }

  onPageShow() {
    // æ¯æ¬¡è¿”å›žæœ¬é¡µæ—¶é‡æ–°ä»Žæ•°æ®åº“æ‹‰ä¸€éï¼Œä¿è¯â€œå½“å‰æ­¥æ•°â€ä¸Ž DB åŒæ­¥
    this.refreshData();
  }

  // åŠ¨æ€è®¡ç®—é«˜åº¦ï¼Œæ”¾å¤§å˜åŒ–è¶‹åŠ¿
  getBarHeight(val: number): number {
    const minHeight = 20; // æœ€å°é«˜åº¦
    const maxHeight = 150; // æœ€å¤§é«˜åº¦
    
    if (this.maxSteps === this.minSteps) return minHeight;

    // å½’ä¸€åŒ–è®¡ç®—
    let percentage = (val - this.minSteps) / (this.maxSteps - this.minSteps);
    return minHeight + percentage * (maxHeight - minHeight);
  }

  build() {
    Stack({ alignContent: Alignment.TopStart }) {
      Column() {
        // 1. é¡¶éƒ¨ Hero Card
        Column() {
          // æ ‡é¢˜æ å ä½
          // ä½¿ç”¨ Stack å°† BackButton æ•´åˆè¿›æ ‡é¢˜æ ï¼Œé˜²æ­¢é®æŒ¡
          Stack({ alignContent: Alignment.Center }) {
            Text('æ­¥æ•°è¶‹åŠ¿')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#FFFFFF')

            Row() {
              BackButton()
            }
            .width('100%')
            .justifyContent(FlexAlign.Start)
            .padding({ left: 16 }) // ç»™æŒ‰é’®ç•™å‡ºè¾¹è·
          }
          .width('100%')
          .height(56)
          .margin({ top: 10 })

          // æ ¸å¿ƒæ•°æ®å±•ç¤º
          Row() {
            Column() {
              Text('ä»Šæ—¥æ­¥æ•°')                       //  æ”¹æ–‡æ¡ˆ
                .fontSize(14)
                .fontColor('rgba(255,255,255,0.9)')
              Text(`${this.todaySteps}`)             // ç›´æŽ¥æ˜¾ç¤º DB ä¸­çš„ä»Šæ—¥æ­¥æ•°
                .fontSize(40)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)

            Blank()

            Column() {
              Text('æ€»è®¡æ­¥æ•°')
                .fontSize(14)
                .fontColor('rgba(255,255,255,0.9)')
              Text(`${this.totalSteps}`)
                .fontSize(24)
                .fontWeight(FontWeight.Medium)
                .fontColor('#FFFFFF')
                .margin({ top: 12 })
            }
            .alignItems(HorizontalAlign.End)
          }
          .width('100%')
          .padding({ left: 24, right: 24, bottom: 36 })
        }
        .width('100%')
        .linearGradient({
          angle: 135,
          colors: [['#FF7E5F', 0.0], ['#FEB47B', 1.0]] // æš–è‰²è°ƒï¼šæ—¥è½æ©™
        })
        .borderRadius({ bottomLeft: 32, bottomRight: 32 })
        .shadow({ radius: 20, color: 'rgba(255, 126, 95, 0.3)', offsetY: 10 })

        // 2. å›¾è¡¨åŒºåŸŸ
        Column() {
          Text('è¿‘æœŸæ´»åŠ¨è®°å½•')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .width('100%')
            .padding({ left: 24, top: 24, bottom: 10 })
          
          if (this.stepsData.length > 0) {
            List({ space: 14 }) {
              ForEach(this.stepsData, (item: HealthData) => {
                ListItem() {
                  Column() {
                    // æŸ±å­èƒŒæ™¯æ§½
                    Stack({ alignContent: Alignment.Bottom }) {
                      Column()
                        .width(8)
                        .height(150)
                        .backgroundColor('#F0F0F0')
                        .borderRadius(4)
                      
                      // å®žé™…æŸ±å­
                      Column()
                        .width(8)
                        .height(this.getBarHeight(item.steps))
                        .linearGradient({
                          angle: 180,
                          colors: item.steps >= this.avgSteps 
                            ? [['#FF7E5F', 0.0], ['#FEB47B', 1.0]] 
                            : [['#BDC3C7', 0.0], ['#E0E0E0', 1.0]]
                        })
                        .borderRadius(4)
                        .shadow({ radius: 4, color: 'rgba(255, 126, 95, 0.2)', offsetY: 2 })
                    }
                    
                    // æ•°å€¼
                    Text(`${item.steps}`)
                      .fontSize(10)
                      .fontColor('#999')
                      .margin({ top: 8 })

                    // æ—¥æœŸ
                    Text(`${(new Date(item.timestamp).getMonth() + 1).toString().padStart(2, '0')}-${new Date(item.timestamp).getDate().toString().padStart(2, '0')}`)
                      .fontSize(10)
                      .fontColor('#CCC')
                      .margin({ top: 2 })
                  }
                  .justifyContent(FlexAlign.End)
                  .height(220)
                }
              })
            }
            .listDirection(Axis.Horizontal)
            .height(260)
            .width('100%')
            .padding({ left: 16, right: 16, bottom: 16 })
            .alignListItem(ListItemAlign.End)
          } else {
            Column() {
              Image($r('app.media.startIcon')).width(60).height(60).opacity(0.1).grayscale(1)
              Text('æš‚æ— æ•°æ®').fontSize(14).fontColor('#CCC').margin({ top: 10 })
            }
            .height(200)
            .justifyContent(FlexAlign.Center)
          }
        }
        .width('92%')
        .backgroundColor('#FFFFFF')
        .borderRadius(24)
        .shadow({ radius: 30, color: 'rgba(0,0,0,0.06)', offsetY: 12 })
        .margin({ top: -24 })

        // 3. åº•éƒ¨æ•°æ®æ¦‚è§ˆ
        Column() {
          Text('æ•°æ®æ¦‚è§ˆ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333')
            .width('100%')
            .margin({ bottom: 12 })

          Grid() {
            GridItem() {
              StatCard({ title: 'å¹³å‡çƒ­é‡', value: `${this.avgCalories}`, unit: 'kcal', color: '#FF7E5F' })
            }
            GridItem() {
              StatCard({ title: 'æ€»é‡Œç¨‹', value: this.totalDistance, unit: 'km', color: '#FEB47B' })
            }
            GridItem() {
              StatCard({ title: 'è¾¾æ ‡å¤©æ•°', value: `${this.stepsData.filter(d => d.steps >= 5000).length}`, unit: 'å¤©', color: '#FF9966' })
            }
            GridItem() {
              StatCard({ title: 'æ´»è·ƒæ—¶é•¿', value: `${Math.round(this.totalSteps / 100)}`, unit: 'min', color: '#FFCC80' })
            }
          }
          .columnsTemplate('1fr 1fr')
          .rowsGap(12)
          .columnsGap(12)
          .height(200)
        }
        .width('100%')
        .padding({ left: 24, right: 24, top: 24 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8F9FB')
    }
  }
}