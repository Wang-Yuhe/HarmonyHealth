// entry/src/main/ets/pages/MedicalHistory/MedicalHistoryPage.ets (æˆ– DiseasePage.ets)
import router from '@ohos.router';
import { MedicalRecord } from '../../common/model/MedicalRecordModel';
import { HealthDB } from '../../database/HealthDB';

@Entry
@Component
export struct DiseasePage {
  @State records: MedicalRecord[] = [];
  // è·å–å½“å‰ç™»å½•ç”¨æˆ· (ç”¨äºæ•°æ®åº“æŸ¥è¯¢)
  @StorageProp('currentUser') currentUser: string = '';

  // æœç´¢å…³é”®è¯çŠ¶æ€
  @State searchText: string = '';

  // é¡µé¢æ˜¾ç¤ºæ—¶ï¼Œä»æ•°æ®åº“é‡æ–°æ‹‰å–æ•°æ®
  async onPageShow() {
    let targetUser = this.currentUser || 'admin'; // å…œåº•
    this.records = await HealthDB.getInstance().getMedicalRecords(targetUser);
  }

  build() {
    Stack({ alignContent: Alignment.BottomEnd }) {
      // åº•å±‚èƒŒæ™¯å®¹å™¨
      Column() {
        // ===============================================
        // 1. é¡¶éƒ¨ç´«è‰²å¤´éƒ¨åŒºåŸŸ
        // ===============================================
        Column() {
          // 1.1 å¯¼èˆªæ  (è¿”å›æŒ‰é’® + æ ‡é¢˜)
          Row() {
            // è¿”å›æŒ‰é’® (ç™½è‰²åœ†å½¢èƒŒæ™¯)
            Button({ type: ButtonType.Circle, stateEffect: true }) {
              Image($r('app.media.backButton')) // ç¡®ä¿èµ„æºå­˜åœ¨
                .width(20).height(20)
                .fillColor('#4A3B99')
            }
            .width(40).height(40)
            .backgroundColor(Color.White)
            .onClick(() => router.back())

            Text('ç–¾ç—…å†å²æ¡£æ¡ˆ')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ left: 16 })

            Blank()
          }
          .width('100%')
          .padding({ top: 12, bottom: 20 })

          // 1.2 ç»Ÿè®¡æ•°æ®å±•ç¤º
          Row() {
            Column() {
              Text(this.records.length.toString()) // å¤§æ•°å­—
                .fontSize(48)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
                .lineHeight(56)

              Text('æ€»è®°å½•æ•°') // å°æ ‡ç­¾
                .fontSize(14)
                .fontColor('rgba(255,255,255,0.7)')
                .margin({ top: 4 })
            }
            .alignItems(HorizontalAlign.Start)

            Blank()
          }
          .width('100%')
          .padding({ left: 10, right: 10, bottom: 30 })

        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 10 })
        // ç´«è‰²æ¸å˜èƒŒæ™¯
        .linearGradient({
          angle: 180,
          colors: [['#4A3B99', 0.0], ['#352880', 1.0]]
        })

        // ===============================================
        // 2. ä¸‹æ–¹ç™½è‰²å¡ç‰‡åŒºåŸŸ
        // ===============================================
        Column() {
          // 2.1 æœç´¢æ¡†
          Search({ placeholder: 'æœç´¢ç—…å†æ ‡é¢˜ã€åŒ»é™¢æˆ–æ—¥æœŸ...' })
            .width('100%')
            .height(45)
            .backgroundColor('#F5F6FA') // æµ…ç°èƒŒæ™¯
            .placeholderColor('#A0A0A0')
            .margin({ top: 20, bottom: 10 })
            .onChange((value: string) => {
              this.searchText = value;
            })

          // 2.2 å†…å®¹åˆ—è¡¨ æˆ– ç©ºçŠ¶æ€
          if (this.records.length === 0) {
            this.buildEmptyState()
          } else {
            List({ space: 14 }) {
              ForEach(this.records.filter(item =>
              item.title.includes(this.searchText) ||
              item.hospital.includes(this.searchText)
              ), (item: MedicalRecord) => {

                ListItem() {
                  this.buildRecordCard(item)
                }
                .onClick(() => {
                  // ä¿®æ­£è·³è½¬è·¯å¾„ï¼ŒæŒ‡å‘è¯¦æƒ…é¡µ
                  router.pushUrl({
                    url: 'pages/RecordEditPage', // ç¡®ä¿è·¯å¾„æ­£ç¡®
                    params: { record: item }
                  })
                })

              }, (item: MedicalRecord) => JSON.stringify(item))

              // åº•éƒ¨å«é«˜
              ListItem().height(80)
            }
            .layoutWeight(1)
            .scrollBar(BarState.Off)
            .edgeEffect(EdgeEffect.Spring)
          }
        }
        .width('100%')
        .layoutWeight(1) // å æ»¡å‰©ä½™é«˜åº¦
        .backgroundColor(Color.White)
        .padding({ left: 20, right: 20 })
        // å·¦ä¸Šå³ä¸Šåœ†è§’
        .borderRadius({ topLeft: 30, topRight: 30 })
        .margin({ top: -20 })
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#352880') // é˜²æ­¢åº•éƒ¨éœ²å‡ºç™½è‰²ç¼éš™

      // ===============================================
      // 3. æ‚¬æµ®æ·»åŠ æŒ‰é’® (FAB) - ç´«è‰²ç³»
      // ===============================================
      Button({ type: ButtonType.Circle, stateEffect: true }) {
        Text('+')
          .fontSize(32)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Lighter)
          .margin({ bottom: 4 })
      }
      .width(60)
      .height(60)
      .backgroundColor('#6C5DD3')
      .shadow({ radius: 10, color: '#40352880', offsetY: 6 })
      .margin({ right: 24, bottom: 32 })
      .onClick(() => {
        // ä¿®æ­£è·³è½¬è·¯å¾„ï¼ŒæŒ‡å‘æ–°å¢é¡µ
        router.pushUrl({ url: 'pages/AddRecordPage' })
      })
    }
    .width('100%')
    .height('100%')
  }

  // --- ç©ºçŠ¶æ€ UI ---
  @Builder buildEmptyState() {
    Column() {
      Text('ğŸ“‚')
        .fontSize(70)
        .margin({ bottom: 20, top: 60 })
        .opacity(0.8)

      Text('æš‚æ— ç—…å†æ•°æ®')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 8 })

      Text('æ‚¨çš„å¥åº·æ¡£æ¡ˆç©ºç©ºå¦‚ä¹Ÿ\nç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å½•å…¥ç¬¬ä¸€æ¡æ•°æ®')
        .fontSize(14)
        .fontColor('#999')
        .textAlign(TextAlign.Center)
        .lineHeight(22)
        .margin({ bottom: 40 })

      Button('ç«‹å³å½•å…¥')
        .width(160)
        .height(42)
        .fontSize(15)
        .backgroundColor('#F0EFFF')
        .fontColor('#4A3B99')
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddRecordPage' })
        })
    }
    .width('100%')
    .height('100%')
    .alignItems(HorizontalAlign.Center)
  }

  // --- ç—…å†å¡ç‰‡ UI ---
  @Builder buildRecordCard(item: MedicalRecord) {
    Row() {
      // å·¦ä¾§è£…é¥°æ¡
      Column()
        .width(4)
        .height(40)
        .backgroundColor('#6C5DD3')
        .borderRadius(2)
        .margin({ right: 12 })

      // ä¸­é—´å†…å®¹
      Column({ space: 4 }) {
        Text(item.title)
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })

        Text(`${typeof item.date === 'string' ? item.date.split('T')[0] : 'æœªçŸ¥æ—¥æœŸ'} | ${item.hospital}`)
          .fontSize(12)
          .fontColor('#999')
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      // å³ä¾§ PDF/å›¾ç‰‡ å›¾æ ‡
      if (item.pdfUri) {
        Text('PDF')
          .fontSize(10)
          .fontColor(Color.White)
          .backgroundColor('#FF6B6B')
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(4)
      } else if (item.imageUri) {
        Image(item.imageUri)
          .width(36).height(36)
          .borderRadius(6)
          .objectFit(ImageFit.Cover)
          .backgroundColor('#F0F0F0')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FBFBFD')
    .borderRadius(16)
    .margin({ bottom: 2 })
  }
}