/**
 * @file LoginPage.ets
 * @description ÁôªÂΩïÁïåÈù¢ÔºàÊîØÊåÅËæìÂÖ•Ë¥¶Âè∑Ëá™Âä®ÂàáÊç¢Â§¥ÂÉèÔºâ
 */
import { PromptAction, Router } from '@kit.ArkUI';
import { Context } from '@kit.AbilityKit';
import { LoginVM } from '../features/login/controller/LoginVM';

@Entry
@Component
struct LoginPage {
  /* ---------------- Áä∂ÊÄÅÂèòÈáè ---------------- */
  @State username: string = '';
  @State password: string = '';
  @State currentAvatar: Resource | string = $r('app.media.profileIcon'); // ÊîØÊåÅ Resource Êàñ URI

  /* ---------------- ÂÆû‰æãÂèòÈáè ---------------- */
  private loginVM: LoginVM = new LoginVM();
  private router: Router | null = null;
  private promptAction: PromptAction | null = null;
  private debounceTimer: number = -1;

  /* ---------------- ÁîüÂëΩÂë®Êúü ---------------- */
  aboutToAppear() {
    const uiContext = this.getUIContext();
    this.router = uiContext.getRouter();
    this.promptAction = uiContext.getPromptAction();
    const abilityContext = this.getUIContext().getHostContext() as Context;
    this.loginVM.initializeDefaultUsers(abilityContext);
  }

  /* ---------------- UI ---------------- */
  build() {
    Column() {
      Text('Harmony\n  Health')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .shaderStyle({
          direction: GradientDirection.LeftTop,
          colors: [['#EC13FC', 0.0], ['#13D8FC', 1]]
        })
        .width('30%')
        .height(50)
        .margin({ top: 60, bottom: 60 })

      /* ========== Â§¥ÂÉèÂå∫Âüü ========== */
      Image(this.currentAvatar) // üëà Áõ¥Êé•ÁªëÂÆö
        .width(80)
        .height(80)
        .borderRadius('50%')
        .margin({ bottom: 60 })
        .objectFit(ImageFit.Cover)

      /* Áî®Êà∑Âêç */
      TextInput({ placeholder: 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç' })
        .placeholderColor('#999999')
        .fontColor('#333333')
        .height(50)
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .padding(10)
        .margin({ bottom: 20 })
        .onChange(v => {
          this.username = v;
          // Èò≤ÊäñÊõ¥Êñ∞Â§¥ÂÉè
          if (this.debounceTimer !== -1) {
            clearTimeout(this.debounceTimer);
          }
          this.debounceTimer = setTimeout(() => {
            this.updateAvatarByUser();
          }, 300);
        })

      /* ÂØÜÁ†Å */
      TextInput({ placeholder: 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å' })
        .type(InputType.Password)
        .placeholderColor('#999999')
        .fontColor('#333333')
        .height(50)
        .width('90%')
        .backgroundColor('#FFFFFF')
        .borderRadius(8)
        .padding(10)
        .margin({ bottom: 30 })
        .onChange(v => this.password = v)

      /* ÁôªÂΩïÊåâÈíÆ */
      Button('ÁôªÂΩï')
        .width('90%')
        .height(50)
        .backgroundColor('#409EFF')
        .fontColor('#FFFFFF')
        .fontSize(20)
        .borderRadius(8)
        .onClick(() => this.handleLogin())

      /* ÊñáÂ≠óÈìæÂå∫Âüü */
      Row() {
        Text('Ê≥®ÂÜåË¥¶Âè∑')
          .fontSize(14)
          .fontColor('#409EFF')
          .onClick(() => this.gotoRegister())
          .margin({ left: 4 })

        Text(' | ')
          .fontSize(14)
          .fontColor('#666666')
          .margin({ left: 4, right: 4 })

        Text('ÂøòËÆ∞ÂØÜÁ†Å')
          .fontSize(14)
          .fontColor('#409EFF')
          .onClick(() => this.gotoResetPwd())
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .margin({ top: 24 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Start)
    .backgroundColor('#F5F6FA')
  }

  /**
   * Ê†πÊçÆÂΩìÂâç username Êü•ËØ¢Áî®Êà∑ÔºåÂπ∂Êõ¥Êñ∞Â§¥ÂÉè
   */
  private async updateAvatarByUser(): Promise<void> {
    if (!this.username.trim()) {
      this.currentAvatar = $r('app.media.profileIcon');
      return;
    }

    try {
      const context = this.getUIContext().getHostContext() as Context;
      const user = await this.loginVM.getUserByUsername(context, this.username);

      if (user && user.avatar) {
        // Âà§Êñ≠ avatar ÊòØÂê¶‰∏∫ÊúâÊïà URIÔºàÊîØÊåÅ file, persist, httpÔºâ
        if (
          user.avatar.startsWith('file://') ||
          user.avatar.startsWith('persist://') ||
          user.avatar.startsWith('http://') ||
          user.avatar.startsWith('https://')
        ) {
          this.currentAvatar = user.avatar; // Áõ¥Êé•‰ΩøÁî® URI
          return;
        }
      }
      // ÂÖúÂ∫ïÔºöÈªòËÆ§Â§¥ÂÉè
      this.currentAvatar = $r('app.media.profileIcon');
    } catch (e) {
      console.warn('Failed to load user avatar:', e);
      this.currentAvatar = $r('app.media.profileIcon');
    }
  }

  /* ==================== ‰∏öÂä°ÈÄªËæë ==================== */

  private validate(): boolean {
    return this.username.length > 0 && this.password.length > 0;
  }

  private async handleLogin(): Promise<void> {
    if (!this.validate()) {
      this.showToast('ËØ∑ËæìÂÖ•Áî®Êà∑ÂêçÂíåÂØÜÁ†Å');
      return;
    }

    try {
      const ctx = this.getUIContext().getHostContext() as Context;
      const ok = await this.loginVM.login(ctx, this.username, this.password);
      if (ok) {
        this.showToast('ÁôªÂΩïÊàêÂäü');
        this.safeNavigate('pages/HomePage', 'replace');
      } else {
        this.showToast('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
      }
    } catch (e) {
      console.error('Login error:', e);
      this.showToast('ÁôªÂΩïÂºÇÂ∏∏');
    }
  }

  private gotoRegister(): void {
    this.safeNavigate('pages/RegisterPage');
  }

  private gotoResetPwd(): void {
    this.safeNavigate('pages/ResetPasswordPage');
  }

  /* ---------------- Â∞ÅË£ÖÊñπÊ≥ï ---------------- */

  private safeNavigate(url: string, mode: 'push' | 'replace' = 'push'): void {
    if (!this.router) {
      this.showToast('È°µÈù¢Ë∑≥ËΩ¨Â§±Ë¥•');
      return;
    }

    try {
      if (mode === 'push') {
        this.router.pushUrl({ url }).catch((e: Error) => {
          console.error('[Nav] pushUrl failed:', url, e);
          this.showToast('È°µÈù¢Ë∑≥ËΩ¨Â§±Ë¥•');
        });
      } else {
        this.router.replaceUrl({ url }).catch((e: Error) => {
          console.error('[Nav] replaceUrl failed:', url, e);
          this.showToast('È°µÈù¢Ë∑≥ËΩ¨Â§±Ë¥•');
        });
      }
    } catch (e) {
      console.error('[Nav] navigation error:', e);
      this.showToast('È°µÈù¢Ë∑≥ËΩ¨Â§±Ë¥•');
    }
  }

  private showToast(msg: string): void {
    try {
      this.promptAction?.showToast({ message: msg, duration: 2000 });
    } catch (error) {
      console.warn('Failed to show toast:', error);
    }
  }
}