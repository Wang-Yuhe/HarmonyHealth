/**
 * @file ResetPasswordPage.ets
 * @description æ‰¾å›å¯†ç é¡µé¢
 */

import { Context } from '@kit.AbilityKit';
import { Router, PromptAction } from '@kit.ArkUI';
import { LoginVM } from '../features/login/controller/LoginVM';
import { BackButton } from '../common/components/BackButton';

@Entry
@Component
struct ResetPasswordPage {
  @State username: string = '';
  @State securityAnswer: string = '';
  @State newPassword: string = '';
  @State confirmPassword: string = '';
  @State securityQuestion: string = '';
  @State showQuestion: boolean = false;

  private loginVM: LoginVM = new LoginVM();
  private promptAction: PromptAction | null = null;
  @Provide router: Router | null = null; // ğŸ‘ˆ å»¶è¿Ÿåˆå§‹åŒ–

  // âœ… å®‰å…¨åˆå§‹åŒ– UI ä¸Šä¸‹æ–‡ï¼ˆé¿å… this.getUIContext() è¿‡æ—©è°ƒç”¨ï¼‰
  aboutToAppear() {
    const uiContext = this.getUIContext();
    this.router = uiContext.getRouter();
    this.promptAction = uiContext.getPromptAction();
  }

  build() {
    Stack() {
      // ä¸»å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨æ ‡é¢˜
        Row() {
          Text('æ‰¾å›å¯†ç ')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
        }
        .width('100%')
        .padding(24)
        .justifyContent(FlexAlign.Center)

        // è¾“å…¥è¡¨å•
        Column() {
          TextInput({ placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å' })
            .width('100%')
            .height(48)
            .margin({ bottom: 16 })
            .onChange((v) => this.username = v)

          Button('è·å–æ‰¾å›é—®é¢˜')
            .width('100%')
            .height(48)
            .margin({ bottom: 16 })
            .backgroundColor('#409EFF')
            .fontColor(Color.White)
            .borderRadius(24)
            .onClick(() => this.getSecurityQuestion())

          if (this.showQuestion) {
            Text(this.securityQuestion)
              .width('100%')
              .margin({ bottom: 16 })
              .fontSize(16)
              .fontColor('#333333')

            TextInput({ placeholder: 'è¯·è¾“å…¥æ‰¾å›é—®é¢˜ç­”æ¡ˆ' })
              .width('100%')
              .height(48)
              .margin({ bottom: 16 })
              .onChange((v) => this.securityAnswer = v)

            TextInput({ placeholder: 'è¯·è¾“å…¥æ–°å¯†ç ' })
              .type(InputType.Password)
              .width('100%')
              .height(48)
              .margin({ bottom: 16 })
              .onChange((v) => this.newPassword = v)

            TextInput({ placeholder: 'è¯·ç¡®è®¤æ–°å¯†ç ' })
              .type(InputType.Password)
              .width('100%')
              .height(48)
              .margin({ bottom: 24 })
              .onChange((v) => this.confirmPassword = v)

            Button('é‡ç½®å¯†ç ')
              .width('100%')
              .height(48)
              .backgroundColor('#409EFF')
              .fontColor(Color.White)
              .fontSize(18)
              .borderRadius(24)
              .onClick(() => this.resetPassword())
          }
        }
        .padding(24)
        .width('100%')
        .backgroundColor('#F8FAFF')
      }
      .width('100%')
      .height('100%')
      .backgroundColor('#F8FAFF')


      if (this.router) {
        BackButton()
          .position({ x: 2, y: 2 })
      }
    }
    .width('100%')
    .height('100%')
  }

  private async getSecurityQuestion() {
    if (!this.username) {
      this.showToast('è¯·è¾“å…¥ç”¨æˆ·å');
      return;
    }

    try {
      const context = this.getUIContext().getHostContext() as Context;
      const user = await this.loginVM.getUserByUsername(context, this.username);
      if (user && user.securityQuestion) {
        this.securityQuestion = user.securityQuestion;
        this.showQuestion = true;
      } else {
        this.showToast('ç”¨æˆ·ä¸å­˜åœ¨æˆ–æœªè®¾ç½®æ‰¾å›é—®é¢˜');
      }
    } catch (e) {
      this.showToast('è·å–é—®é¢˜å¤±è´¥');
    }
  }

  private async resetPassword() {
    if (!this.securityAnswer || !this.newPassword || !this.confirmPassword) {
      this.showToast('è¯·å®Œå–„æ‰€æœ‰ä¿¡æ¯');
      return;
    }

    if (this.newPassword !== this.confirmPassword) {
      this.showToast('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´');
      return;
    }

    try {
      const context = this.getUIContext().getHostContext() as Context;
      const success = await this.loginVM.resetPassword(
        context,
        this.username,
        this.securityAnswer,
        this.newPassword
      );
      if (success) {
        this.showToast('å¯†ç é‡ç½®æˆåŠŸ');
        this.router?.back(); // âœ… å®‰å…¨è°ƒç”¨
      } else {
        this.showToast('æ‰¾å›é—®é¢˜ç­”æ¡ˆé”™è¯¯');
      }
    } catch (e) {
      this.showToast('é‡ç½®å¯†ç å¤±è´¥');
    }
  }

  private showToast(msg: string): void {
    try {
      this.promptAction?.showToast({ message: msg, duration: 2000 });
    } catch (error) {
      console.warn('Failed to show toast:', error);
    }
  }
}