import picker from '@ohos.file.picker';
import promptAction from '@ohos.promptAction';
import { OCRUtils } from '../utils/OCRUtils';
import { ParsedInfo, RecordParser } from './RecordParser';

@Component
export struct MedicalRecordForm {
  // ä½¿ç”¨ @Link å®žçŽ°åŒå‘ç»‘å®šï¼Œçˆ¶é¡µé¢ä¿®æ”¹è¿™é‡Œä¹Ÿä¼šå˜ï¼Œè¿™é‡Œä¿®æ”¹çˆ¶é¡µé¢ä¹Ÿä¼šå˜
  @Link title: string;
  @Link content: string;
  @Link selectedImage: string;
  @Link hospital: string;
  @Link selectedDate: Date;
  @Link tags: string[];
  @Link pdfUri: string;
  @State isRecognizing: boolean = false;

  // é€‰æ‹©å›¾ç‰‡é€»è¾‘
  async selectImage() {
    try {
      let photoPicker = new picker.PhotoViewPicker();
      let result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });
      if (result.photoUris.length > 0) {
        this.selectedImage = result.photoUris[0];
        this.pdfUri = ''; // äº’æ–¥ï¼šé€‰äº†å›¾ç‰‡å°±æ¸…ç©º PDF
        this.askForOCR('å›¾ç‰‡');
      }
    } catch (err) {
      console.error('å›¾ç‰‡é€‰æ‹©å¤±è´¥', err);
    }
  }
  // é€‰æ‹© PDF æ–‡ä»¶
  async selectPDF() {
    try {
      let docPicker = new picker.DocumentViewPicker();
      let result = await docPicker.select({
        maxSelectNumber: 1,
        defaultFilePathUri: ''
        // æ³¨æ„ï¼šä¸åŒ API ç‰ˆæœ¬ fileSuffixFilters å†™æ³•ä¸åŒï¼Œé€šå¸¸ DocumentPicker é»˜è®¤å…è®¸é€‰æ‰€æœ‰æ–‡ä»¶
      });

      if (result.length > 0) {
        this.pdfUri = result[0];
        this.selectedImage = ''; // äº’æ–¥ï¼šé€‰äº† PDF å°±æ¸…ç©ºå›¾ç‰‡
        this.askForOCR('PDF æ–‡ä»¶');
      }
    } catch (err) {
      console.error('æ–‡ä»¶é€‰æ‹©å¤±è´¥', err);
    }
  }
  askForOCR(type: string) {
    promptAction.showDialog({
      title: 'æ™ºèƒ½åŠ©æ‰‹',
      message: `æ£€æµ‹åˆ°æ‚¨ä¸Šä¼ äº† ${type}ï¼Œæ˜¯å¦æ™ºèƒ½è¯†åˆ«å†…å®¹ï¼Ÿ`,
      buttons: [{ text: 'å–æ¶ˆ', color: '#666' }, { text: 'è¯†åˆ«', color: '#007DFF' }]
    }).then((resp) => {
      if (resp.index === 1) this.startOCR();
    });
  }

  async startOCR() {
    this.isRecognizing = true;
    try {
      let text = '';

      // åˆ†æ”¯é€»è¾‘ï¼šåˆ¤æ–­æ˜¯å›¾ç‰‡è¿˜æ˜¯ PDF
      if (this.selectedImage) {
        text = await OCRUtils.recognizeText(this.selectedImage);
      } else if (this.pdfUri) {
        text = await OCRUtils.recognizePdf(this.pdfUri);
      } else {
        promptAction.showToast({ message: 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶' });
        return;
      }

      this.content = text;
      const info: ParsedInfo = RecordParser.parse(text);
      // åªæœ‰å½“è¾“å…¥æ¡†æ˜¯ç©ºçš„æ—¶å€™æ‰è‡ªåŠ¨å¡«ï¼Œé˜²æ­¢è¦†ç›–ç”¨æˆ·å·²ç»æ‰‹å†™çš„
      if (info.hospital && !this.hospital) {
        this.hospital = info.hospital;
      }

      if (info.title && !this.title) {
        this.title = info.title;
      }

      if (info.date) {
        this.selectedDate = info.date;
      }

      promptAction.showToast({ message: 'è¯†åˆ«æˆåŠŸå¹¶å·²è‡ªåŠ¨å¡«å†™ï¼' });
    } catch(e) {
      promptAction.showToast({ message: 'è¯†åˆ«å¤±è´¥' });
    } finally {
      this.isRecognizing = false;
    }
  }

  build() {
    Scroll() {
      Column({ space: 15 }) {
        // 1. æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ (æ•´åˆäº† å›¾ç‰‡ å’Œ PDF)
        Column() {
          // æƒ…å†µ A: å·²é€‰æ‹©å›¾ç‰‡
          if (this.selectedImage) {
            Image(this.selectedImage)
              .width('100%').height(200).objectFit(ImageFit.Contain)
              .onClick(() => this.selectImage()) // ç‚¹å‡»æ›´æ¢

            Text('ç‚¹å‡»å›¾ç‰‡å¯æ›´æ¢').fontSize(12).fontColor('#999').margin({top: 5})
          }
          // æƒ…å†µ B: å·²é€‰æ‹© PDF
          else if (this.pdfUri) {
            Column() {
              // è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ª PDF çš„å°å›¾æ ‡ï¼Œå¦‚æžœæ²¡æœ‰å°±ç”¨ Text ä»£æ›¿
              Text('ðŸ“„ PDF æ–‡æ¡£').fontSize(40)
              Text(this.pdfUri.split('/').pop()) // æ˜¾ç¤ºæ–‡ä»¶å
                .fontSize(14).margin({ top: 10 }).fontColor('#333')
                .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%').height(150)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('#FFF4E6') // æ·¡æ©™è‰²èƒŒæ™¯åŒºåˆ†
            .onClick(() => this.selectPDF()) // ç‚¹å‡»æ›´æ¢

            Text('ç‚¹å‡»æ–‡æ¡£å¯æ›´æ¢').fontSize(12).fontColor('#999').margin({top: 5})
          }
          // æƒ…å†µ C: æœªé€‰æ‹©
          else {
            Row({ space: 20 }) {
              // æ‹ç…§/é€‰å›¾æŒ‰é’®
              Column() {
                Text('ðŸ“·').fontSize(30)
                Text('ç…§ç‰‡/æ‹ç…§').fontSize(12).fontColor('#666').margin({top:5})
              }
              .onClick(() => this.selectImage())
              .layoutWeight(1).height(100).backgroundColor('#F1F3F5')
              .justifyContent(FlexAlign.Center).borderRadius(8)

              // é€‰ PDF æŒ‰é’®
              Column() {
                Text('ðŸ“‚').fontSize(30)
                Text('å¯¼å…¥ PDF').fontSize(12).fontColor('#666').margin({top:5})
              }
              .onClick(() => this.selectPDF())
              .layoutWeight(1).height(100).backgroundColor('#F1F3F5')
              .justifyContent(FlexAlign.Center).borderRadius(8)
            }
          }

          // OCR æŒ‰é’® (åªè¦æœ‰ä»»æ„æ–‡ä»¶é€‰ä¸­å°±æ˜¾ç¤º)
          if (this.selectedImage || this.pdfUri) {
            Button(this.isRecognizing ? 'AI è¯†åˆ«ä¸­...' : 'æ™ºèƒ½å†…å®¹æå–')
              .margin({ top: 15 }).width('100%')
              .backgroundColor(this.isRecognizing ? '#CCCCCC' : '#007DFF')
              .onClick(() => this.startOCR())
          }
        }
        .padding(15).backgroundColor(Color.White).borderRadius(12)

        // 2. è¡¨å•åŒºåŸŸ
        Column({ space: 10 }) {
          Text('åŸºæœ¬ä¿¡æ¯').fontWeight(FontWeight.Bold)
          TextInput({ placeholder: 'æ ‡é¢˜', text: this.title })
            .onChange((val) => this.title = val)
          TextInput({ placeholder: 'åŒ»é™¢', text: this.hospital })
            .onChange((val) => this.hospital = val)

          Row() {
            Text('æ—¥æœŸï¼š').fontSize(16)
            Text(this.selectedDate.toISOString().split('T')[0]).fontColor('#007DFF')
              .onClick(() => {
                DatePickerDialog.show({
                  selected: this.selectedDate,
                  onAccept: (val) => this.selectedDate.setFullYear(val.year, val.month, val.day)
                })
              })
          }.width('100%').padding({ top: 5 })
        }.padding(15).backgroundColor(Color.White).borderRadius(12)

        // 3. è¯¦æƒ…ä¸Žæ ‡ç­¾
        Column({ space: 10 }) {
          Text('è¯¦ç»†å†…å®¹').fontWeight(FontWeight.Bold)
          TextArea({ placeholder: 'ç—…åŽ†è¯¦æƒ…...', text: this.content })
            .height(150)
            .onChange((val) => this.content = val)

          Text('æ ‡ç­¾: ' + this.tags.join(', ')).fontSize(14).fontColor('#666')
        }.padding(15).backgroundColor(Color.White).borderRadius(12)
      }.padding(16)
    }
  }
}