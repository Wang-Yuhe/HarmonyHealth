import picker from '@ohos.file.picker';
import promptAction from '@ohos.promptAction';
import { CloudOCRUtils } from '../utils/CloudOCRUtils';
import { OCRUtils } from '../utils/OCRUtils';
import { ParsedInfo, RecordParser } from './RecordParser';

@Component
export struct MedicalRecordForm {
  // ä½¿ç”¨ @Link å®ç°åŒå‘ç»‘å®šï¼Œçˆ¶é¡µé¢ä¿®æ”¹è¿™é‡Œä¹Ÿä¼šå˜ï¼Œè¿™é‡Œä¿®æ”¹çˆ¶é¡µé¢ä¹Ÿä¼šå˜
  @Link title: string;
  @Link content: string;
  @Link selectedImage: string;
  @Link hospital: string;
  @Link selectedDate: Date;
  @Link tags: string[];
  @Link pdfUri: string;
  @State isRecognizing: boolean = false;

  // ç”¨äºæš‚å­˜å¼¹çª—æ˜¾ç¤ºçš„æ–‡å­—
  @State dialogTitle: string = '';
  @State dialogMessage: string = '';

  // ğŸ”¥ æ³¨å†Œè‡ªå®šä¹‰å¼¹çª—æ§åˆ¶å™¨
  dialogController: CustomDialogController = new CustomDialogController({
    builder: WarningDialog({
      title: this.dialogTitle,
      message: this.dialogMessage
    }),
    autoCancel: true, // ç‚¹å‡»ç©ºç™½å¤„æ˜¯å¦å…³é—­
    alignment: DialogAlignment.Center
  });

  private showCustomAlert(title: string, msg: string) {
    // 1. è®¾ç½®æ˜¾ç¤ºçš„æ–‡å­—
    this.dialogTitle = title;
    this.dialogMessage = msg;

    // 2. æ‰“å¼€è‡ªå®šä¹‰å¼¹çª—
    this.dialogController.open();
  }

  // é€‰æ‹©å›¾ç‰‡é€»è¾‘
  async selectImage() {
    try {
      let photoPicker = new picker.PhotoViewPicker();
      let result = await photoPicker.select({
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE,
        maxSelectNumber: 1
      });
      if (result.photoUris.length > 0) {
        this.selectedImage = result.photoUris[0];
        this.pdfUri = ''; // äº’æ–¥ï¼šé€‰äº†å›¾ç‰‡å°±æ¸…ç©º PDF
        this.askForOCR('å›¾ç‰‡');
      }
    } catch (err) {
      // æ•è·æ–‡ä»¶é€‰æ‹©å™¨æœ¬èº«çš„é”™è¯¯ï¼ˆå¦‚æƒé™è¢«æ‹’ï¼‰
      console.error('å›¾ç‰‡é€‰æ‹©å¼‚å¸¸:', JSON.stringify(err));
      this.showCustomAlert('æ— æ³•é€‰æ‹©å›¾ç‰‡', 'è¯»å–ç›¸å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦æˆäºˆäº†ç›¸å…³æƒé™ã€‚');
    }
  }
  // é€‰æ‹© PDF æ–‡ä»¶
  async selectPDF() {
    try {
      let docPicker = new picker.DocumentViewPicker();
      let result = await docPicker.select({
        maxSelectNumber: 1,
        defaultFilePathUri: ''
        // æ³¨æ„ï¼šä¸åŒ API ç‰ˆæœ¬ fileSuffixFilters å†™æ³•ä¸åŒï¼Œé€šå¸¸ DocumentPicker é»˜è®¤å…è®¸é€‰æ‰€æœ‰æ–‡ä»¶
      });

      if (result.length > 0) {
        this.pdfUri = result[0];
        this.selectedImage = ''; // äº’æ–¥ï¼šé€‰äº† PDF å°±æ¸…ç©ºå›¾ç‰‡
        this.askForOCR('PDF æ–‡ä»¶');
      }
    } catch (err) {
      console.error('æ–‡ä»¶é€‰æ‹©å¼‚å¸¸:', JSON.stringify(err));
      this.showCustomAlert('æ— æ³•å¯¼å…¥æ–‡æ¡£', 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚');
    }
  }
  askForOCR(type: string) {
    promptAction.showDialog({
      title: 'æ™ºèƒ½åŠ©æ‰‹',
      message: `æ£€æµ‹åˆ°æ‚¨ä¸Šä¼ äº† ${type}ï¼Œæ˜¯å¦æ™ºèƒ½è¯†åˆ«å†…å®¹ï¼Ÿ`,
      buttons: [{ text: 'å–æ¶ˆ', color: '#666' }, { text: 'è¯†åˆ«', color: '#007DFF' }]
    }).then((resp) => {
      if (resp.index === 1) this.startOCR();
    });
  }

  async startOCR() {
    this.isRecognizing = true;
    this.content = ""; // å…ˆæ¸…ç©º

    try {
      let text = '';

      if (this.selectedImage) {
        text = await CloudOCRUtils.recognizeTable(this.selectedImage);
      } else if (this.pdfUri) {
        text = await CloudOCRUtils.recognizePdf(this.pdfUri);
      } else {
        this.showCustomAlert('æç¤º', 'è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
        return;
      }

      // ğŸ”¥ğŸ”¥ğŸ”¥ã€å…³é”®ä¿®æ”¹ã€‘åªæ‹¦æˆªå¸¦ "ERROR:" å‰ç¼€çš„ç³»ç»Ÿé”™è¯¯
      // è¿™æ ·æ— è®ºç—…å†å†…å®¹é‡Œæœ‰å¤šå°‘ä¸ªâ€œå¼‚å¸¸â€æˆ–â€œå¤±è´¥â€ï¼Œéƒ½ä¸ä¼šè¯¯è§¦å‘å¼¹çª—äº†
      if (text.startsWith('ERROR:')) {
        // å»æ‰å‰ç¼€å†æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œä½“éªŒæ›´å¥½
        const showMsg = text.replace('ERROR:', '').trim();
        this.showCustomAlert('è¯†åˆ«ä¸­æ–­', showMsg);
      } else {
        // æˆåŠŸï¼
        this.content = text;
        promptAction.showToast({ message: 'æ™ºèƒ½æå–æˆåŠŸ' });

        // æ™ºèƒ½å¡«å……
        const info = RecordParser.parse(text);
        if (info.title) this.title = info.title;
        if (info.hospital) this.hospital = info.hospital;
        if (info.date) this.selectedDate = info.date;
      }

    } catch(e) {
      this.showCustomAlert('ç³»ç»Ÿå¼‚å¸¸', e.message);
    } finally {
      this.isRecognizing = false;
    }
  }

  build() {
    Scroll() {
      Column({ space: 15 }) {
        // 1. æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ (æ•´åˆäº† å›¾ç‰‡ å’Œ PDF)
        Column() {
          // æƒ…å†µ A: å·²é€‰æ‹©å›¾ç‰‡
          if (this.selectedImage) {
            Image(this.selectedImage)
              .width('100%').height(200).objectFit(ImageFit.Contain)
              .onClick(() => this.selectImage()) // ç‚¹å‡»æ›´æ¢

            Text('ç‚¹å‡»å›¾ç‰‡å¯æ›´æ¢').fontSize(12).fontColor('#999').margin({top: 5})
          }
          // æƒ…å†µ B: å·²é€‰æ‹© PDF
          else if (this.pdfUri) {
            Column() {
              // è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ª PDF çš„å°å›¾æ ‡ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨ Text ä»£æ›¿
              Text('ğŸ“„ PDF æ–‡æ¡£').fontSize(40)
              Text(this.pdfUri.split('/').pop()) // æ˜¾ç¤ºæ–‡ä»¶å
                .fontSize(14).margin({ top: 10 }).fontColor('#333')
                .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .width('100%').height(150)
            .justifyContent(FlexAlign.Center)
            .backgroundColor('#FFF4E6') // æ·¡æ©™è‰²èƒŒæ™¯åŒºåˆ†
            .onClick(() => this.selectPDF()) // ç‚¹å‡»æ›´æ¢

            Text('ç‚¹å‡»æ–‡æ¡£å¯æ›´æ¢').fontSize(12).fontColor('#999').margin({top: 5})
          }
          // æƒ…å†µ C: æœªé€‰æ‹©
          else {
            Row({ space: 20 }) {
              // æ‹ç…§/é€‰å›¾æŒ‰é’®
              Column() {
                Text('ğŸ“·').fontSize(30)
                Text('ç…§ç‰‡/æ‹ç…§').fontSize(12).fontColor('#666').margin({top:5})
              }
              .onClick(() => this.selectImage())
              .layoutWeight(1).height(100).backgroundColor('#F1F3F5')
              .justifyContent(FlexAlign.Center).borderRadius(8)

              // é€‰ PDF æŒ‰é’®
              Column() {
                Text('ğŸ“‚').fontSize(30)
                Text('å¯¼å…¥ PDF').fontSize(12).fontColor('#666').margin({top:5})
              }
              .onClick(() => this.selectPDF())
              .layoutWeight(1).height(100).backgroundColor('#F1F3F5')
              .justifyContent(FlexAlign.Center).borderRadius(8)
            }
          }

          // OCR æŒ‰é’® (åªè¦æœ‰ä»»æ„æ–‡ä»¶é€‰ä¸­å°±æ˜¾ç¤º)
          if (this.selectedImage || this.pdfUri) {
            Button(this.isRecognizing ? 'AI è¯†åˆ«ä¸­...' : 'æ™ºèƒ½å†…å®¹æå–')
              .margin({ top: 15 }).width('100%')
              .backgroundColor(this.isRecognizing ? '#CCCCCC' : '#007DFF')
              .onClick(() => this.startOCR())
          }
        }
        .padding(15).backgroundColor(Color.White).borderRadius(12)

        // 2. è¡¨å•åŒºåŸŸ
        Column({ space: 10 }) {
          Text('åŸºæœ¬ä¿¡æ¯').fontWeight(FontWeight.Bold)
          TextInput({ placeholder: 'æ ‡é¢˜', text: this.title })
            .onChange((val) => this.title = val)
          TextInput({ placeholder: 'åŒ»é™¢', text: this.hospital })
            .onChange((val) => this.hospital = val)

          Row() {
            Text('æ—¥æœŸï¼š').fontSize(16)
            Text(this.selectedDate.toISOString().split('T')[0]).fontColor('#007DFF')
              .onClick(() => {
                DatePickerDialog.show({
                  selected: this.selectedDate,
                  onAccept: (val) => this.selectedDate.setFullYear(val.year, val.month, val.day)
                })
              })
          }.width('100%').padding({ top: 5 })
        }.padding(15).backgroundColor(Color.White).borderRadius(12)

        // 3. è¯¦æƒ…ä¸æ ‡ç­¾
        Column({ space: 10 }) {
          Text('è¯¦ç»†å†…å®¹').fontWeight(FontWeight.Bold)

          TextArea({ placeholder: 'è¯†åˆ«ç»“æœ...', text: this.content })
            .height(300) // é«˜åº¦è®¾é«˜ä¸€ç‚¹ï¼Œæ–¹ä¾¿çœ‹è¡¨æ ¼
            .backgroundColor('#F9F9F9')
            .onChange((val) => this.content = val)
            // ğŸ”¥ğŸ”¥ğŸ”¥ã€å…³é”®ä¿®æ”¹ã€‘è®¾ç½®ç­‰å®½å­—ä½“
            .fontFamily('monospace')
            .fontSize(9) // ç¨å¾®æ”¹å°å­—ä½“ï¼Œé˜²æ­¢è¡¨æ ¼å¤ªå®½æ¢è¡Œ
        }.padding(15).backgroundColor(Color.White).borderRadius(12)
      }.padding(16)
    }
  }
}
// --- è‡ªå®šä¹‰è­¦å‘Šå¼¹çª—ç»„ä»¶ ---
@CustomDialog
struct WarningDialog {
  controller: CustomDialogController;
  title: string = '';
  message: string = '';

  // ğŸ”¥ 1. å®šä¹‰ X è½´åç§»é‡çŠ¶æ€
  @State offsetX: number = 0;

  // ğŸ”¥ 2. åœ¨å¼¹çª—æ˜¾ç¤ºæ—¶è§¦å‘åŠ¨ç”»
  aboutToAppear() {
    // å»¶è¿Ÿ 50ms ç¡®ä¿å¼¹çª—å·²æ¸²æŸ“ï¼Œç„¶åå¼€å§‹æŠ–åŠ¨
    setTimeout(() => {
      this.startShake();
    }, 50);
  }

  // ğŸ”¥ 3. å®šä¹‰æŠ–åŠ¨åŠ¨ç”»é€»è¾‘
  startShake() {
    // ä½¿ç”¨ keyframeAnimateTo å®šä¹‰ä¸€ç»„è¿ç»­åŠ¨ä½œ
    this.getUIContext().keyframeAnimateTo({ iterations: 1 }, [
      // ç¬¬ä¸€é˜¶æ®µï¼šå¿«é€Ÿå‘å·¦
      { duration: 50, event: () => { this.offsetX = -10 } },
      // ç¬¬äºŒé˜¶æ®µï¼šå¿«é€Ÿå‘å³
      { duration: 50, event: () => { this.offsetX = 10 } },
      // ç¬¬ä¸‰é˜¶æ®µï¼šå¹…åº¦å‡å°å‘å·¦
      { duration: 50, event: () => { this.offsetX = -5 } },
      // ç¬¬å››é˜¶æ®µï¼šå¹…åº¦å‡å°å‘å³
      { duration: 50, event: () => { this.offsetX = 5 } },
      // ç¬¬äº”é˜¶æ®µï¼šå›æ­£
      { duration: 50, event: () => { this.offsetX = 0 } },
    ]);
  }

  build() {
    Column() {
      // 1. é¡¶éƒ¨å›¾æ ‡
      Text('âš ï¸')
        .fontSize(40)
        .margin({ top: 20, bottom: 10 })

      // 2. æ ‡é¢˜
      Text(this.title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333')
        .margin({ bottom: 8 })

      // 3. å†…å®¹
      Text(this.message)
        .fontSize(16)
        .fontColor('#FF4D4F')
        .fontWeight(FontWeight.Medium)
        .textAlign(TextAlign.Center)
        .lineHeight(24)
        .margin({ bottom: 20, left: 15, right: 15 })

      // 4. åº•éƒ¨æŒ‰é’®
      Button('çŸ¥é“äº†')
        .width('80%')
        .height(40)
        .backgroundColor('#F5F5F5')
        .fontColor('#666')
        .onClick(() => {
          this.controller.close();
        })
        .margin({ bottom: 20 })
    }
    .backgroundColor(Color.White)
    .borderRadius(16)
    .width('80%')
    // ğŸ”¥ 4. å°†åç§»é‡ç»‘å®šåˆ°ç»„ä»¶çš„ translate å±æ€§ä¸Š
    .translate({ x: this.offsetX })
  }
}